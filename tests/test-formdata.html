<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8"/>
        <title>Test FormData</title>
        <style>
            body {
                background-color: slategray;
            }
            form {
                display: flex;
                flex-flow: column nowrap;
                justify-content: center;
                align-items: stretch;
                gap: 10px;
                width: 100%;
                * {
                    padding-top: 1rem;
                    padding-bottom: 1rem;
                }
                button[type=submit] {
                    background-color: chocolate;
                    width: 30%;
                    margin-left: auto;
                    margin-right: auto;
                }
                div#results {
                    color: coral;
                    font-size: small;
                    font-family: "Nota Sans Mono", monospace;
                }
            }
            .hidden {
                position: absolute;
                height: 0;
                margin: 0;
            }
        </style>
        <script type="text/javascript" src="../js/usefulworks.js"></script>
        <script type="text/javascript" src="../js/usefulworks-forms.js"></script>
        <script type="text/javascript" src="../js/usefulworks-ratchet.js"></script>
    </head>
    <body>
        <main>
            <form name="the-form" action="https://httpbin.org/post" method="POST">
                <input type="text"     name="field1" placeholder="i'm field one" />
                <input type="text"     name="field2" placeholder="i'm field two" disabled />
                <input type="hidden"   name="field3" placeholder="i'm field three" />
                <input type="checkbox" name="field4" value="heatray" class="hidden" checked />
                <textarea name="txtrea" rows="5" cols="30">i am some text</textarea>
                <button type="submit" name="submit-button">Submit</button>
                <!-- results -->
                <div id="results"></div>
            </form>
        </main>
        <script type="text/javascript">
            const echo_servers = {
                beeceptor: "https://echo.free.beeceptor.com/",
                httpbin: "https://httpbin.org/post"
            }
            const body = {
                name: "martian",
                weapon: "heatray",
                battlecry: "ulla"
            };


            // top level handler
            $UW(window).on("unhandledrejection", (e) => {
                e.preventDefault();
                $UW.debug.warn(`** unhandledrejection ${e.reason} **`);
            });

            async function postData() {
                const opts = {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Access-Control-Allow-Origin': '*',
                        'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
                        'Access-Control-Allow-Headers': 'Content-Type',
                    },
                    body: body
                }

                 // works as designed; but async fn
/*                 return fetch(echo_servers.beeceptor, opts)
                        .then(async function(response) {
                            let json = await response.json();
                            return { response, json };
                        }); */

                async function process(response) {
                    try {
                        let json = await response.json();
                        return ( { response, json } );

                    } catch (e) {
                        $UW.debug.warn("errrrrrr!");
                    }
                }

                return fetch(echo_servers.beeceptor, opts)
                            .catch(error => $UW.debug.error(`oops! problem whilst fetching: ${error}`))
                            .then(response => {
                                return process(response).catch('errrrrr');
                            })
                            .catch(error => $UW.debug.error(`oops! problem retrieving json: ${error}`))
                            .catch(error => $UW.debug.error(`oops! another problem: ${error}`));
            }

            $UW(async function(e) {

                $UW.log("ready");

                const test = (async () =>{ return 6})();
                const val  = await test;

                const result = await postData();
                $UW.log(`response: ${result.response.status}:${result.response.statusText}`);
                $UW.log(`json: ${JSON.stringify(result.json, null, 2)}`);

                const fx = UsefulWorksForms(document.forms[0]);
                fx.addBeforeSubmitEventListener(function(e){
                    $UW.log("beforesubmit");
                    e.preventDefaultOnOrigin();

                    const json = fx.submit();
                    document.querySelector("div#results").innerText = JSON.stringify(json, null, 2);
                });

                fx.addNewFormDataEventListener(function(e){
                    $UW.log("newformdata[before]");

                    const data = e.formData;

                    data.append("field4", "ulla");
                    data.set("field5", "i'm set")
                    data.delete("field3");

                    $UW.log(`newformdata[after]: ${JSON.stringify(Object.fromEntries(e.formData))}`)
                });


                let x = 0;
            });

            const form = document.forms[0];

            //form.addEventListener("submit", onSubmit);
            //form.addEventListener("formdata", onFormData);

            function onSubmit(e) {
                e.preventDefault();
                console.log("onsubmit[before]");

                const data = new FormData(form); // triggers formdata event

                console.log(`onsubmit[after]: ${JSON.stringify(Object.fromEntries(data))}`); // retains effect of onformdata handler

                const keys = data.keys();
                for(const k of keys) {
                    console.log(`${k} => ${data.getAll(k)}`);
                }

            }

            function onFormData(e) {
                console.log(`onformdata[before]: ${JSON.stringify(Object.fromEntries(e.formData))}`);

                const data = e.formData;

                data.append("field4", "ulla");
                data.set("field5", "i'm set")
                data.delete("field3");

                // iterator
                for(const p of data) {
                    console.log(p);
                }

                console.log(`onformdata[after]: ${JSON.stringify(Object.fromEntries(e.formData))}`);
            }

        </script>
    </body>
</html>